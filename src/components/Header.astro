---
import Clock from "../components/Clock.astro";
import Nav from "../components/Nav.astro";
---

<header
  class="items-top flex w-full flex-col justify-between gap-4 py-[var(--margin)] text-pretty transition-transform duration-300 will-change-transform"
>
  <div class="cutoff flex flex-row justify-between">
    <div
      class="flex w-full flex-row items-center justify-between gap-2 md:flex-col md:items-start"
    >
      <h1 class="heading-1 w-auto text-balance">
        Graduate Studio: Technology A
        <Clock />

        <div class="mt-4 flex flex-row gap-4 md:hidden">
          <h2>
            <a
              href="https://www.pratt.edu/design/graduate-communications-design/"
              >Pratt Grad ComD MFA</a
            >
          </h2>
          <h2>DES 720A</h2>
        </div>
      </h1>
      <Nav />
    </div>
    <div class="hidden md:block">
      <h2>
        <a href="https://www.pratt.edu/design/graduate-communications-design/"
          >Pratt Grad ComD</a
        >
      </h2>
      <h2>DES 720A</h2>
    </div>
  </div>
</header>

<script>
  import { gsap } from "gsap";

  document.addEventListener("DOMContentLoaded", () => {
    const header = document.querySelector("header");
    const elements = document.querySelectorAll(
      "header h1, header h2, .clock-container",
    );

    const getScrollY = () => window.scrollY || window.pageYOffset;
    let lastScrollY = getScrollY();
    let ticking = false;

    function getHeaderBounds() {
      const top = header.offsetTop;
      const height = header.offsetHeight;
      const bottom = top + height;
      return { top, height, bottom };
    }

    function updateFontScale() {
      const scrollY = getScrollY();
      const { top, bottom } = getHeaderBounds();

      let scale;
      if (scrollY <= top) {
        scale = 1;
      } else if (scrollY >= bottom) {
        scale = 0.3;
      } else {
        const progress = (scrollY - top) / (bottom - top);
        scale = 1 - 0.7 * progress;
      }

      elements.forEach((el) => {
        gsap.set(el, { "--font-scale": scale });
      });
    }

    function updateHeaderVisibility(scrollY, direction) {
      const { height, bottom } = getHeaderBounds();

      // ↓ This is the key "line" for when the header is hidden ↓
      const hideThreshold = bottom + height * 2;

      if (scrollY >= hideThreshold && direction === 1) {
        header.classList.add("-translate-y-full"); // typically moves header -100% up
      } else if (direction === -1) {
        header.classList.remove("-translate-y-full");
      }
    }

    function onScroll() {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          const scrollY = getScrollY();
          const direction = scrollY > lastScrollY ? 1 : -1;

          updateFontScale();
          updateHeaderVisibility(scrollY, direction);

          lastScrollY = Math.max(scrollY, 0);
          ticking = false;
        });

        ticking = true;
      }
    }

    window.addEventListener("scroll", onScroll);
    window.addEventListener("resize", updateFontScale);

    window.addEventListener("load", () => {
      updateFontScale();
      const scrollY = getScrollY();
      const direction = 1;
      updateHeaderVisibility(scrollY, direction);
    });
  });
</script>
